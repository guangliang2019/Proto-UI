# Props 契约底本（草案）

本文是 Props v0 的**中文契约底本**，用于统一当前行为与未来实现的目标。  
重点强调**语义层规则**与**运行时容忍度**的边界，后续实现与测试应以本文为准修订。

---

## 1. 基本定位

Props 是 **app maker → 组件（原型）** 的信息通路，用于提供可移植的数据配置。  
事件回调属于 expose 通路语义（组件 → app maker），不属于 props 语义（详见 expose 契约）。

---

## 2. 类型与可序列化要求（JSON-like）

### 2.1 语义约束（强约束）

Props 值必须是 **JSON-like 可移植数据**：

- 允许：`string | number | boolean | null | object | array`
- 不允许：`undefined | function | symbol | bigint | class instance | Date | RegExp | Map/Set | DOM/非纯数据对象`
- `undefined` **在类型层面不允许出现**。

### 2.2 运行期容忍（弱约束）

运行期输入若含 `undefined`，必须**统一归一为 `null`**：

- raw props 中若出现 `undefined`，在解析阶段会被视为 “provided-empty”
- resolved props 中**不得出现 `undefined`**，空值统一为 `null`

> 说明：运行期仍可能接收到非 JSON-like 值，但此类值不保证跨 adapter 可移植，属于不推荐用法。

---

## 3. 核心概念

### 3.1 输入状态分类（每个 key）

- **missing**：raw 中不存在该 key
- **provided-empty**：raw 中存在该 key，值为 `null` 或 `undefined`
- **provided-non-empty**：raw 中存在该 key，且值非 `null/undefined`
- **invalid**：provided-non-empty 且不满足校验（type/enum/range/validator）

### 3.2 规范空值

- **`null` 是唯一空值**
- resolved 快照中**绝不出现** `undefined`

---

## 4. Prop 声明与合并（define）

### 4.1 形状约束

- `type` 必须为 `any | boolean | string | number | object`
- `empty` 只能是 `accept | fallback | error`
- `range.min/max` 必须是 number

### 4.2 合并规则（同 key）

- **type 必须一致**：不一致 → error
- **empty**：
  - 变严格（accept → fallback → error）→ error
  - 变宽松 → warning，但**保持原有更严格**（行为不放松）
  - omit → 不改变
- **enum**：
  - incoming 是子集 → error
  - incoming 是超集 → warning
  - 相等 → ok
- **range**：
  - incoming 更窄 → error
  - incoming 更宽 → warning
- **validator**：
  - 允许新增
  - 替换/移除 → error
- **default**：
  - 首次新增允许
  - 变更 → warning，**保留旧值**

> 合并失败必须是原子性的：一旦 error，整个 define 不生效。

---

## 5. 解析语义（raw → resolved）

### 5.1 输出约束

- resolved 只包含已声明 key
- resolved **不包含 undefined**
- resolved 始终包含所有声明 key

### 5.2 EmptyBehavior

#### empty=accept

- 仅对 provided-empty 生效 → resolved 为 `null`
- missing 仍走 fallback 语义
- invalid 非空仍走 fallback/error

#### empty=fallback（默认）

- missing / provided-empty / invalid → fallback 链

#### empty=error

- missing / provided-empty / invalid → 必须找到**非空合法 fallback**，否则抛错

### 5.3 Fallback 链（顺序）

1. prevValid（上一轮非空合法值）
2. setDefaults（后设优先）
3. decl.default
4. null（仅在 empty 非 error 时允许）

### 5.4 prevValid 规则

- 只记录 **非空合法值**
- `null` 不会写入 prevValid

> 注意：missing 情况是否允许使用 prevValid，需要在实现中**与本契约对齐**。

---

## 6. Watch 语义

### 6.1 Resolved Watch

- diff 使用 `Object.is`
- 首次 applyRaw（hydration）不触发
- watchAll 先于 watch(keys) 触发

### 6.2 Raw Watch

- diff 使用 `Object.is`
- 首次 applyRaw 不触发
- watchRawAll 先于 watchRaw(keys)
- raw watchers 属于 escape hatch，应产生开发期 warning（可开关）

---

## 7. 非目标

Props v0 不定义：

- 跨生态的序列化协议（仅定义 JSON-like 语义）
- 富类型系统/复杂 schema
- adapter 中 props 映射规则（由 adapter 契约定义）
