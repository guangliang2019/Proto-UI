# Props Raw Watch 契约（v0）

本文定义 `def.props.watchRaw` / `def.props.watchRawAll` 的行为。Raw watch 是 escape hatch。

---

## 1. 定义

- **raw snapshot**：`props.getRaw()` 返回的对象
  - 可能包含未声明 key
  - 可能包含 `undefined`
  - 浅冻结

- **change detection**：使用 `Object.is(prev[key], next[key])`

---

## 2. Hydration 规则

首次 `applyRaw(...)` 属于 hydration：
- raw watchers 不触发
- resolved watchers 不触发

---

## 3. watchRawAll(cb)

触发条件：
- raw key 集合 = `keys(prevRaw) ∪ keys(nextRaw)`
- 只有当 unionKeys 中至少一个 key 变化时触发

回调参数：
- `cb(run, nextRaw, prevRaw, info)`
- `info.changedKeysAll`：unionKeys 中变化的 key
- `info.changedKeysMatched === info.changedKeysAll`

---

## 4. watchRaw(keys, cb)

注册约束：
- keys 必须非空
- keys **不要求**已声明

触发条件：
- keys 中至少一个 key 在 raw 中变化

回调参数：
- `info.changedKeysAll`：unionKeys 中变化的 key
- `info.changedKeysMatched`：keys 中变化的子集

---

## 5. 调用顺序

在一次触发性 `applyRaw(...)` 中：
1. raw watchers 先于 resolved watchers
2. raw watchers 内：`watchRawAll` → `watchRaw(keys)`（均按注册顺序）

---

## 6. Warning 约束（escape hatch）

当 raw watcher 在一次 apply 中被评估时，应记录开发期 warning（可配置开关）：
- `watchRawAll()`：`[Props] watchRawAll() is an escape hatch; avoid in official prototypes.`
- `watchRaw(keys)`：`[Props] watchRaw() is an escape hatch; avoid in official prototypes.`

