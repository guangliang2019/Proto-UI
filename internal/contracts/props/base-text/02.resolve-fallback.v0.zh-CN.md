# Props 解析与回退契约（v0）

本文定义 raw props 解析为 resolved props 的行为，以及 empty/invalid 的处理规则。

---

## 1. 输入分类

对每个声明 key：

- **missing**：raw 中不存在该 key
- **provided-empty**：raw 中存在该 key，值为 `null` 或 `undefined`
- **provided-non-empty**：raw 中存在且非 `null/undefined`
- **invalid**：provided-non-empty，但不满足校验（type/enum/range/validator）

---

## 2. 公共运行时 API

- `get()`：返回 resolved 快照
  - 仅包含已声明 key
  - 绝不包含 `undefined`
  - 浅冻结

- `getRaw()`：返回 raw 快照
  - 可能包含未声明 key
  - 可能包含 `undefined`

- `isProvided(key)`：判断 raw 中是否存在该 key（own property）

---

## 3. resolved 输出不变量

- resolved 只包含声明 key
- resolved 不包含 `undefined`
- 所有声明 key 必须存在
- **`null` 是唯一空值**

---

## 4. EmptyBehavior 语义

### 4.1 empty=accept

- 只作用于 provided-empty
- provided-empty → resolved 为 `null`
- missing 仍走 fallback
- invalid 仍走 fallback/error

### 4.2 empty=fallback（默认）

- missing / provided-empty / invalid → fallback 链

### 4.3 empty=error

- missing / provided-empty / invalid → 必须找到**非空合法 fallback**，否则抛错

---

## 5. Fallback 链（顺序）

1. prevValid（上一轮非空合法值）
2. setDefaults（后设优先）
3. decl.default
4. null（仅在 empty 非 error 时允许）

> **确认点**：missing 场景是否允许使用 prevValid？当前实现中 missing 不使用 prevValid；若要维持现状，需要在实现中明确对齐。

---

## 6. prevValid 规则

- 仅记录非空合法值
- `null` 不写入 prevValid
- invalid 不更新 prevValid

---

## 7. 校验语义（v0）

- type 校验（最小化）：
  - boolean → `typeof v === "boolean"`
  - string → `typeof v === "string"`
  - number → `typeof v === "number" && !Number.isNaN(v)`
  - object → `typeof v === "object"`
  - any → 总是通过

- enum/range/validator 失败 → invalid

---

## 8. JSON-like 语义约束（补充）

- props 值语义上应为 JSON-like（可移植数据）
- `undefined` 不允许作为语义值；运行期若出现，必须归一为 `null`
- 非 JSON-like 值允许存在，但不保证跨 adapter 行为
