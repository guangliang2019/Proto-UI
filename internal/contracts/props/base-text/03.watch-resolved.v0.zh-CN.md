# Props Resolved Watch 契约（v0）

本文定义 `def.props.watch` / `def.props.watchAll` 的行为。

---

## 1. 定义

- **resolved snapshot**：通过 `props.get()` 获取的快照
  - 仅含已声明 key
  - 不包含 `undefined`
  - 浅冻结

- **change detection**：使用 `Object.is(prev[key], next[key])`

---

## 2. Hydration 规则

首次 `applyRaw(...)` 属于 hydration：

- resolved watchers 不触发
- raw watchers 不触发

---

## 3. watchAll(cb)

触发条件：

- 仅当**至少一个已声明 key 发生 resolved 变化**时触发

回调参数：

- `cb(run, next, prev, info)`
- `info.changedKeysAll`：所有已声明且发生变化的 key
- `info.changedKeysMatched === info.changedKeysAll`

---

## 4. watch(keys, cb)

注册约束：

- keys 必须非空
- keys 必须全部为已声明 key

触发条件：

- keys 中至少一个 key 在 resolved 中发生变化

回调参数：

- `info.changedKeysAll`：所有已声明且变化的 key
- `info.changedKeysMatched`：keys 中变化的子集

---

## 5. 调用顺序

在一次触发性 `applyRaw(...)` 中：

1. `watchAll` 按注册顺序评估与触发
2. `watch(keys)` 按注册顺序评估与触发

---

## 6. 与解析语义的关系

resolved watch 观察的是 **解析后的快照**：

- raw 变化不一定导致 resolved 变化
- watch 只由 resolved 差异触发
