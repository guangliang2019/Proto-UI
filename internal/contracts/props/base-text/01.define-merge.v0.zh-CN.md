# Props 定义与合并契约（v0）

本文定义 Props 在 `define()` 时的合并行为。所有规则以 **traceability 与向后演进安全** 为目标：

- 破坏性变化必须立即报错
- 可扩展变化允许但需可追踪（warning）

---

## 1. 范围与术语

- **Base**：系统中已存在的声明
- **Incoming**：本次 `define()` 提供的新声明
- **Diagnostic**：本次合并产生的警告或错误
  - error：`define()` 必须抛错，且**不产生任何变更**
  - warning：合并成功但需记录

---

## 2. 基本形状校验（v0 最小校验）

对每个 incoming prop：

- `type` 必须为 `any | boolean | string | number | object`
- 若显式提供 `empty`，只能是 `accept | fallback | error`
- 若提供 `range`：`min/max` 必须是 number

以上校验失败必须 **error**。

---

## 3. 合并规则（同 key）

### 3.1 type

- Base 与 Incoming 的 `type` 必须一致
- 不一致 → **error**

### 3.2 empty

严格度顺序（宽松 → 严格）：

```
accept < fallback < error
```

- Incoming 更严格 → **error**
- Incoming 更宽松 → **warning**，但**保留原有更严格**
- Incoming omit → 不影响 base

### 3.3 enum

- Incoming 是 Base 的**子集** → **error**
- Incoming 是 Base 的**超集** → **warning**
- 相等 → ok
- Base 无 enum 且 Incoming 有 → ok
- Incoming omit → 保留 Base

> v0 enum 比较使用 `String(...)` 语义。

### 3.4 range

- Incoming 更窄 → **error**
- Incoming 更宽 → **warning**
- Base 无 range 且 Incoming 有 → ok
- Incoming omit → 保留 Base

> 范围比较以 “允许区间是否变窄/变宽” 为准。

### 3.5 validator

- Base 无 validator，Incoming 新增 → ok
- 替换或移除 → **error**

### 3.6 default

- 首次新增 default → ok
- default 变更 → **warning**，**保留原有 default**

---

## 4. 合并结果与原子性

- 合并失败必须原子性：**任一 error，整个 define 不生效**
- 合并成功：
  - `type` 保持 base
  - `empty/enum/range/validator/default` 按上述规则合并
  - 其他字段按 object spread 合并

---

## 5. 继承说明

本契约继承 v0 英文契约的结构，但根据当前讨论修订了：

- empty 放宽时保留更严格（不放松）
- validator 允许新增
- default 变更不生效
