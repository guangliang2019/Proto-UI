# Expose Event 契约（v0）

> Status: Draft – v0
>
> Expose Event 将“对外事件通路”的语义与 event 模块绑定，形成可被 adapter 映射的稳定事件 API。

---

## 0. 目标

- 明确 event expose 的语义：组件 → App Maker 的通知通路
- 建立与 event 模块的绑定规则
- 为 adapter 的事件映射提供统一入口

---

## 1. 定义 API（setup-only）

```ts
def.expose.event(key, spec);
```

### 1.1 ExposeEventSpec

```ts
type ExposeEventSpec = {
  // 事件 payload 的语义描述（v0 最小化）
  payload?: 'void' | 'any' | 'json';
  // 预留字段（v0 不使用）
  options?: Record<string, unknown>;
};
```

> v0 不强制校验 payload 结构，仅提供语义提示。

---

## 2. 绑定规则（event 模块）

- `def.expose.event` 必须注册到 event 模块的 **对外事件通道**
- 对外事件通道拥有独立命名空间，避免与 DOM 原生事件冲突
- 组件触发对外事件必须通过 event 模块的 emit 能力

### 2.1 新增 event emit API（v0）

```ts
def.event.emit(key: string, payload?: any, options?: Record<string, unknown>): void
```

- `key` 必须是已注册的 expose.event key
- 未注册 key → error
- `options` 在 v0 中预留，不参与行为

---

## 3. Adapter 映射

- React：
  - expose.event → props callback（如 `onXxx`）
  - emit → 调用 props callback
- Vue：
  - expose.event → emits 声明
  - emit → `ctx.emit`
- WebComponent：
  - expose.event → CustomEvent
  - emit → `dispatchEvent`

---

## 4. 运行期语义

- emit 仅在组件实例存活期有效
- dispose 后 emit 必须失败或可区分地报错
- event payload 应满足 JSON-like 语义（与 props 一致的可移植性要求）

---

## 5. 错误模型

必须报错：

- setup 外调用 `def.expose.event`
- `key` 非字符串
- 重复 event key
- emit 未注册事件 key
- dispose 后 emit

建议错误码：

- `EXPOSE_EVENT_PHASE_VIOLATION`
- `EXPOSE_EVENT_INVALID_KEY`
- `EXPOSE_EVENT_DUPLICATE_KEY`
- `EXPOSE_EVENT_UNREGISTERED`
- `EXPOSE_EVENT_DISPOSED`

---

## 6. 相关契约

- expose core：`internal/contracts/expose/expose.v0.md`
- event core：`internal/contracts/event/*.v0.md`
