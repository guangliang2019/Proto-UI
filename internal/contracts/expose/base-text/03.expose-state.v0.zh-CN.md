# Expose State 契约（v0）

> Status: Draft – v0
>
> expose-state 定义：组件通过 `def.expose.state` 将内部状态槽投影为对外只读状态 handle。外部 handle 与内部状态同源，但能力不同（只读 + 可订阅）。

---

## 0. 范围与非目标

### 0.1 范围（v0）

- setup-time `def.expose.state(key, handle)`
- 对外状态 handle 的最小 API 形态
- 内外同源一致性
- 生命周期与错误模型

### 0.2 非目标（v0）

- 不提供外部写能力
- 不保证调度/批处理/顺序

---

## 1. 术语

- **Internal State Handle**：内部 state handle view
- **External State Handle**：App Maker 面向的只读 handle
- **State Slot**：组件内部状态槽

---

## 2. API 形态

```ts
def.expose.state(key, handle);
```

> 等价于 `def.expose(key, handle)`，但附加 expose-state 语义约束。

---

## 3. External State Handle 最小形态

必须提供：

- `get(): V`
- `subscribe(cb): Unsubscribe`
- `unsubscribe(token)` 或 `subscribe` 返回的取消函数

不得提供：

- `set` 或任何写能力

### 3.1 必需 meta：`spec`

External State handle 必须包含只读 `spec: StateSpec`，用于语义说明。

---

## 4. 同源一致性

- `get()` 必须返回内部当前值
- 内部变化应触发外部订阅回调（最小一致性）

事件形状建议与 `StateEvent<V>` 对齐（不包含 `run`）。

---

## 5. 生命周期

- setup-only 注册
- dispose 后外部 `get/subscribe` 必须失败或可区分地报错

---

## 6. 错误模型

- setup 外调用 `def.expose.state`
- dispose 后使用
- 外部写入尝试（若存在）

---

## 7. 相关契约

- expose core：`internal/contracts/expose/expose.v0.md`
- state core：`internal/contracts/state/state-v0.md`
