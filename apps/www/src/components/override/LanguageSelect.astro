---
import context from 'virtual:starlight/project-context';
import config from 'virtual:starlight/user-config';
import { localizedUrl } from '../../utils/localizedUrl';

/**
 * Get the equivalent of the current page path for the passed locale.
 */
function localizedPathname(locale: string | undefined): string {
    return localizedUrl(Astro.url, locale, context.trailingSlash).pathname;
}

const currentLocale = Astro.locals.starlightRoute.locale;

// Get all available locales from config
const locales = config.locales ? Object.keys(config.locales) : [];

// If no locales available, don't render the component
if (locales.length === 0) {
    return;
}

const localeOptions = locales.map((localeKey) => ({
    value: localeKey,
    label: config.locales![localeKey].label || localeKey,
    path: localizedPathname(localeKey),
    isCurrent: localeKey === currentLocale,
}));

// Build the locale paths data attribute for JavaScript
const localePaths: Record<string, string> = {};
localeOptions.forEach((opt) => {
    localePaths[opt.value] = opt.path;
});
---

<div class="language-select-wrapper relative inline-flex items-center">
    <label class="sr-only" for="language-select">选择语言 / Select Language</label>
    <select
        id="language-select"
        class="language-select appearance-none inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all outline-none h-8 rounded-md gap-1.5 px-3 pr-8 cursor-pointer bg-transparent text-foreground hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]"
        aria-label="选择语言 / Select Language"
        autocomplete="off"
        data-current-locale={currentLocale || ''}
        data-locale-paths={JSON.stringify(localePaths)}
        value={currentLocale || ''}
    >
        {localeOptions.map((option) => (
            <option value={option.value} selected={option.isCurrent}>
                {option.label}
            </option>
        ))}
    </select>
    <svg
        class="language-select-arrow absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-foreground opacity-60 transition-opacity w-4 h-4"
        width="16"
        height="16"
        viewBox="0 0 16 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
    >
        <path
            d="M4 6L8 10L12 6"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
        />
    </svg>
</div>

<style>
    .language-select-wrapper:hover .language-select-arrow {
        opacity: 1;
    }

    /* Custom arrow removal for different browsers */
    .language-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        border: 1px solid transparent;
    }

    /* Ensure option styles work in dropdown */
    .language-select option {
        background-color: hsl(var(--color-popover));
        color: hsl(var(--color-popover-foreground));
        padding: 0.5rem;
    }

    /* Focus visible border */
    .language-select:focus-visible {
        border-color: hsl(var(--color-ring));
    }

    /* For Firefox */
    @-moz-document url-prefix() {
        .language-select {
            text-indent: 0;
        }
    }
</style>

<script is:inline>
    (function () {
        function initLanguageSelect() {
            const select = document.getElementById('language-select');
            if (!select) return;

            const currentLocale = select.dataset.currentLocale || '';
            let localePaths = {};
            try {
                localePaths = JSON.parse(select.dataset.localePaths || '{}');
            } catch (e) {
                console.error('[Language Select] Failed to parse locale paths:', e);
                return;
            }

            function handleLanguageChange() {
                const newLocale = select.value;
                const newPath = localePaths[newLocale];

                if (newPath && newLocale && newLocale !== currentLocale) {
                    // Save user's language preference to Cookie (valid for 1 year)
                    const expires = new Date();
                    expires.setFullYear(expires.getFullYear() + 1);
                    document.cookie = `preferred-locale=${newLocale}; path=/; expires=${expires.toUTCString()}; SameSite=Lax`;

                    console.log('[Language Switch] Saved locale to cookie:', newLocale);
                    window.location.pathname = newPath;
                }
            }

            select.addEventListener('change', handleLanguageChange);
        }

        // Ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLanguageSelect);
        } else {
            initLanguageSelect();
        }
    })();
</script>